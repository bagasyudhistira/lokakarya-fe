<p-toast></p-toast>
<app-navbar></app-navbar>
<br />
<div class="manage-user-container">
  <div class="page-title">
    <h1>{{ selectedName }}'s {{ selectedYear }} Attitude Skills</h1>
  </div>
  <div class="header-actions">
    <div class="top-row">
      <!-- For HR users, show the user dropdown -->
      <div *ngIf="currentRoles.includes('HR')" class="user-selection">
        <label for="userSelect">Select User: </label>
        <p-dropdown
          id="userSelect"
          [options]="employees"
          [(ngModel)]="selectedUserId"
          optionLabel="full_name"
          optionValue="id"
          placeholder="{{ selectedName }}"
          (onChange)="fetchEmpAttitudeSkills()"
          appendTo="body"
        ></p-dropdown>
      </div>
      <!-- Assessment Year -->
      <div class="assessment-year-selection">
        <label for="assessmentYear">Assessment Year: </label>
        <p-calendar
          id="assessmentYear"
          [(ngModel)]="selectedAssessmentYear"
          view="year"
          dateFormat="yy"
          (onSelect)="fetchEmpAttitudeSkills()"
          [maxDate]="maxDate"
          placeholder="{{ selectedYear }}"
        ></p-calendar>
      </div>
    </div>
  </div>

  <div class="table-container">
    <!-- Attitude Skill Table -->
    <table class="attitude-skill-table">
      <thead>
        <tr>
          <th>Group</th>
          <th>Attitude Skill</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let group of groupedEmpAttitudeSkills">
          <tr>
            <td [attr.rowspan]="group.attitudeSkills.length">
              {{ group.group_name }}
            </td>
            <td>{{ group.attitudeSkills[0]?.attitude_skill_name }}</td>
            <td>{{ getScoreLabel(group.attitudeSkills[0]?.score) }}</td>
          </tr>
          <tr
            *ngFor="
              let attitudeSkill of group.attitudeSkills;
              let i = index;
              trackBy: trackByIndex
            "
            [hidden]="i === 0"
          >
            <td>{{ attitudeSkill.attitude_skill_name }}</td>
            <td>{{ getScoreLabel(attitudeSkill.score) }}</td>
          </tr>
        </ng-container>
      </tbody>
    </table>
    <div class="edit-button-container">
      <button
        pButton
        label="Edit"
        icon="pi pi-pencil"
        class="p-button-primary"
        (click)="openEditDialog()"
        [disabled]="isProcessing || isEditFormLoading"
      ></button>
    </div>
  </div>

  <!-- Edit Dialog -->
  <p-dialog
    header="Edit Employee Attitude Skills"
    [(visible)]="displayEditDialog"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    [style]="{ width: '70vw' }"
    [resizable]="false"
  >
    <form (ngSubmit)="submitEmployeeAttitudeSkill()">
      <div class="p-fluid">
        <div class="p-field">
          <label for="assessment_year">Assessment Year</label>
          <div style="padding: 0.5rem 0">
            <p-calendar
              id="assessment_year"
              [(ngModel)]="assessmentYear"
              name="assessment_year"
              view="year"
              dateFormat="yy"
              [maxDate]="maxDate"
              required
              placeholder="{{ selectedYear }}"
              [disabled]="true"
            ></p-calendar>
          </div>
        </div>

        <div class="p-field">
          <table class="p-datatable edit-form-table">
            <thead>
              <tr>
                <th>Group</th>
                <th>Attitude Skill</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let group of groupedEmpAttitudeSkills">
                <!-- Group Row -->
                <tr>
                  <td [attr.rowspan]="group.attitudeSkills.length">
                    {{ group.group_name }}
                  </td>
                  <td>{{ group.attitudeSkills[0]?.attitude_skill_name }}</td>
                  <td>
                    <p-dropdown
                      [(ngModel)]="group.attitudeSkills[0].score"
                      name="Score_{{ group.group_id }}_0"
                      [options]="scoreOptions"
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Select Score"
                      [disabled]="isProcessing"
                      appendTo="body"
                    ></p-dropdown>
                  </td>
                </tr>
                <!-- Attitude Skill Rows -->
                <tr
                  *ngFor="
                    let attitudeSkill of group.attitudeSkills;
                    let i = index;
                    trackBy: trackByIndex
                  "
                  [hidden]="i === 0"
                >
                  <td>{{ attitudeSkill.attitude_skill_name }}</td>
                  <td>
                    <p-dropdown
                      [(ngModel)]="attitudeSkill.score"
                      name="Score_{{ group.group_id }}_{{ i }}"
                      [options]="scoreOptions"
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Select Score"
                      [disabled]="isProcessing"
                      appendTo="body"
                    ></p-dropdown>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </div>
      <div class="dialog-footer">
        <button
          pButton
          type="button"
          icon="pi pi-times"
          class="p-button-text"
          label="Cancel"
          [disabled]="isProcessing"
          (click)="displayEditDialog = false"
        ></button>
        <button
          pButton
          type="submit"
          [label]="isProcessing ? 'Saving...' : 'Save'"
          [disabled]="isProcessing"
          class="p-button-primary"
        >
          <ng-container *ngIf="isProcessing">
            <i class="pi pi-spin pi-spinner"></i>
          </ng-container>
        </button>
      </div>
    </form>
  </p-dialog>
</div>
